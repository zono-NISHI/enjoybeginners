<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>YouTube æŒ‡å®šæ™‚åˆ»ã‚¸ãƒ£ãƒ³ãƒ—ï¼ˆç¹°ã‚Šè¿”ã—å¯¾å¿œï¼‰</title>
  <meta name="theme-color" content="#111827" />
  <link rel="manifest" href="manifest.webmanifest" />
  <style>
    :root{--bg:#0f172a;--card:#111827;--muted:#9ca3af;--text:#f9fafb;--accent:#22d3ee}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0f172a 40%);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    .wrap{max-width:760px;margin:0 auto;padding:24px 16px 80px}
    .card{background:rgba(17,24,39,.7);backdrop-filter: blur(10px);border:1px solid rgba(255,255,255,.06);border-radius:20px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.3)}
    h1{font-size:22px;margin:0 0 12px}
    p.lead{color:var(--muted);margin-top:4px}
    label{display:block;font-size:14px;margin:12px 0 6px;color:#e5e7eb}
    input,button,select{font:inherit}
    input[type="url"], input[type="datetime-local"], input[type="time"], input[type="date"], input[type="number"]{
      width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background:#0b1020;color:var(--text);outline:none
    }
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:640px){.row{grid-template-columns:1fr 1fr}}
    .btn{display:inline-flex;gap:8px;align-items:center;border:none;border-radius:12px;padding:12px 16px;font-weight:600;cursor:pointer}
    .primary{background:var(--accent);color:#06202a}
    .ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.14)}
    .danger{background:#ef4444;color:white}
    .muted{color:var(--muted);font-size:13px}
    .badge{display:inline-block;font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.16);color:#93c5fd}
    .lock{display:flex;align-items:center;gap:8px;margin-top:8px}
    .grid{display:grid;gap:12px}
    .yt{aspect-ratio:16/9;background:#0b1020;border:1px dashed rgba(255,255,255,.12);border-radius:12px;display:flex;align-items:center;justify-content:center;color:#94a3b8}
    .footer{margin-top:18px;font-size:12px;color:#a1a1aa}
    .hidden{display:none}
    .list{margin-top:14px;display:grid;gap:10px}
    .item{border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px;display:grid;gap:8px;background:rgba(255,255,255,.02)}
    .item .top{display:flex;justify-content:space-between;gap:12px;align-items:center}
    .chip{font-size:12px;padding:2px 8px;border:1px solid rgba(255,255,255,.16);border-radius:999px}
    .weekday{display:flex;gap:6px;flex-wrap:wrap}
    .weekday label{display:inline-flex;gap:6px;align-items:center;border:1px solid rgba(255,255,255,.14);padding:6px 10px;border-radius:999px;cursor:pointer;font-size:12px}
    .dates{display:flex;gap:8px;flex-wrap:wrap}
    .dates input[type="date"]{width:auto}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ğŸ“º YouTube æŒ‡å®šæ™‚åˆ»ã§é€šçŸ¥ï¼†è‡ªå‹•é·ç§»ï¼ˆç¹°ã‚Šè¿”ã—å¯¾å¿œï¼‰</h1>
      <p class="lead">å‹•ç”»URLã¨æ™‚åˆ»ãƒ»ç¹°ã‚Šè¿”ã—ãƒ«ãƒ¼ãƒ«ã‚’è¨­å®šã€‚æ™‚é–“ã«ãªã‚‹ã¨é€šçŸ¥ã—ã€æŒ‡å®šå‹•ç”»ã¸ã‚¸ãƒ£ãƒ³ãƒ—ã—ã¾ã™ã€‚</p>

      <div class="grid" role="form" aria-label="YouTubeãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼è¨­å®š">
        <div>
          <label for="videoUrl">å¯¾è±¡ã®YouTubeå‹•ç”»URL</label>
          <input id="videoUrl" type="url" placeholder="https://www.youtube.com/watch?v=XXXXXXXX" inputmode="url" />
          <div class="muted">ã‚·ãƒ§ãƒ¼ãƒˆURLï¼ˆyoutu.beï¼‰ã‚„ /shorts/ ã‚‚OK</div>
        </div>

        <div class="row">
          <div>
            <label for="startSec">é–‹å§‹ä½ç½®ï¼ˆç§’ãƒ»ä»»æ„ï¼‰</label>
            <input id="startSec" type="number" min="0" placeholder="ä¾‹ï¼‰120" />
          </div>
          <div class="lock" style="margin-top:28px">
            <input id="lockMode" type="checkbox" />
            <label for="lockMode">é–²è¦§å¿…é ˆãƒ¢ãƒ¼ãƒ‰ï¼ˆå®Œäº†ã¾ã§ã‚¢ãƒ—ãƒªå†…ãƒªãƒ³ã‚¯ã‚’ãƒ­ãƒƒã‚¯ï¼‰</label>
          </div>
        </div>

        <hr style="opacity:.2;border:none;border-top:1px solid rgba(255,255,255,.15)" />

        <!-- ç¹°ã‚Šè¿”ã—è¨­å®š -->
        <div>
          <label for="repeatKind">ç¹°ã‚Šè¿”ã—</label>
          <select id="repeatKind">
            <option value="once">1å›ã ã‘ï¼ˆæ—¥æ™‚æŒ‡å®šï¼‰</option>
            <option value="daily">æ¯æ—¥ï¼ˆæ™‚åˆ»æŒ‡å®šï¼‰</option>
            <option value="weekly">æ›œæ—¥æŒ‡å®šï¼ˆæ™‚åˆ»ï¼‹æ›œæ—¥ï¼‰</option>
            <option value="dates">æ—¥ä»˜æŒ‡å®šï¼ˆè¤‡æ•°æ—¥ï¼‹æ™‚åˆ»ï¼‰</option>
          </select>
        </div>

        <div id="onceBox">
          <label for="onceDateTime">æ—¥æ™‚ï¼ˆç«¯æœ«ã®ç¾åœ°æ™‚åˆ»ï¼‰</label>
          <input id="onceDateTime" type="datetime-local" />
        </div>

        <div id="dailyBox" class="hidden">
          <label for="dailyTime">æ™‚åˆ»ï¼ˆæ¯æ—¥ï¼‰</label>
          <input id="dailyTime" type="time" />
        </div>

        <div id="weeklyBox" class="hidden">
          <label for="weeklyTime">æ™‚åˆ»ï¼ˆæ›œæ—¥æŒ‡å®šã®æ¯é€±ï¼‰</label>
          <input id="weeklyTime" type="time" />
          <div class="weekday" style="margin-top:8px">
            <!-- 0:æ—¥,1:æœˆ,...6:åœŸ -->
            <label><input type="checkbox" class="wday" value="1">æœˆ</label>
            <label><input type="checkbox" class="wday" value="2">ç«</label>
            <label><input type="checkbox" class="wday" value="3">æ°´</label>
            <label><input type="checkbox" class="wday" value="4">æœ¨</label>
            <label><input type="checkbox" class="wday" value="5">é‡‘</label>
            <label><input type="checkbox" class="wday" value="6">åœŸ</label>
            <label><input type="checkbox" class="wday" value="0">æ—¥</label>
          </div>
          <div class="muted">å°‘ãªãã¨ã‚‚1ã¤é¸ã‚“ã§ãã ã•ã„</div>
        </div>

        <div id="datesBox" class="hidden">
          <label for="datesTime">æ™‚åˆ»ï¼ˆå„æ—¥ä»˜ã«é©ç”¨ï¼‰</label>
          <input id="datesTime" type="time" />
          <div class="dates" style="margin-top:8px" id="datesContainer"></div>
          <button class="btn ghost" id="addDate" type="button">ï¼‹ æ—¥ä»˜ã‚’è¿½åŠ </button>
        </div>

        <div class="row actions">
          <button id="enableNotif" class="btn ghost" type="button" aria-label="é€šçŸ¥ã‚’è¨±å¯">ğŸ”” é€šçŸ¥ã‚’è¨±å¯</button>
          <button id="addSchedule" class="btn primary" type="button">â–¶ äºˆç´„ã‚’è¿½åŠ </button>
          <button id="stayAwake" class="btn ghost" type="button">ğŸ’¡ ç”»é¢æ¶ˆç¯é˜²æ­¢</button>
          <button id="exportJson" class="btn ghost" type="button">â¬‡ ãƒ‡ãƒ¼ã‚¿æ›¸ãå‡ºã—</button>
          <button id="importJson" class="btn ghost" type="button">â¬† ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿</button>
          <input id="importFile" type="file" accept="application/json" class="hidden" />
        </div>

        <div id="status" class="badge" aria-live="polite">æº–å‚™ä¸­</div>

        <div class="yt hidden" id="ytBox" aria-label="åŸ‹ã‚è¾¼ã¿å‹•ç”»é ˜åŸŸ">ï¼ˆé–²è¦§å¿…é ˆãƒ¢ãƒ¼ãƒ‰ï¼šå‹•ç”»å®Œäº†ã§è§£é™¤ï¼‰</div>

        <h3 style="margin:14px 0 6px">ğŸ“… ç™»éŒ²æ¸ˆã¿ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h3>
        <div id="list" class="list" aria-live="polite"></div>

        <div class="footer">
          <div>â€» ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ã‚‹ï¼ã‚¹ãƒªãƒ¼ãƒ—ä¸­ã¯ã‚¿ã‚¤ãƒãƒ¼ãŒé…å»¶ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚é–‹ã„ãŸã¾ã¾ã®é‹ç”¨ãŒæœ€ã‚‚ç¢ºå®Ÿã§ã™ã€‚</div>
          <div>â€» iOSã¯é€šçŸ¥ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨±å¯ãŒå¿…è¦ã€‚ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã™ã‚‹ã¨å®‰å®šã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
    function normalizeYouTubeUrl(raw, startSec) {
      if (!raw) return null;
      try {
        let url = new URL(raw);
        // youtu.be â†’ watch?v=
        if (url.hostname === "youtu.be") {
          const id = url.pathname.replace("/", "");
          url = new URL("https://www.youtube.com/watch?v=" + id);
        }
        // shorts â†’ watch?v=
        if (url.pathname.startsWith("/shorts/")) {
          const id = url.pathname.split("/")[2] || "";
          url = new URL("https://www.youtube.com/watch?v=" + id);
        }
        // start ç§’ã‚’ä¸€è²«ã—ã¦ start= ã«å¯„ã›ã‚‹ï¼ˆt ãŒã‚ã‚Œã°å–ã‚Šè¾¼ã‚€ï¼‰
        const incomingT = url.searchParams.get("t");
        const incomingStart = url.searchParams.get("start");
        let start = Number(startSec || incomingStart || incomingT || 0);
        start = Number.isFinite(start) && start > 0 ? Math.floor(start) : 0;
        if (start > 0) {
          url.searchParams.delete("t");
          url.searchParams.set("start", String(start));
        }
        return url.toString();
      } catch {
        return null;
      }
    }

    async function requestNotificationPermission() {
      if (!("Notification" in window)) { alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯é€šçŸ¥ã«æœªå¯¾å¿œã§ã™ã€‚"); return "unsupported"; }
      if (Notification.permission === "granted") return "granted";
      if (Notification.permission === "denied") return "denied";
      try { return await Notification.requestPermission(); } catch { return "denied"; }
    }

    function notify(title, body) {
      try { if (Notification.permission === "granted") new Notification(title, { body }); } catch(e){ console.warn(e); }
    }

    // ===== Wake Lock =====
    let wakeLock = null;
    async function toggleWakeLock() {
      try {
        if (!("wakeLock" in navigator)) { alert("Wake Lockã«æœªå¯¾å¿œã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã™ã€‚"); return; }
        if (!wakeLock) {
          wakeLock = await navigator.wakeLock.request("screen");
          document.getElementById("stayAwake").textContent = "ğŸ’¤ ç”»é¢æ¶ˆç¯é˜²æ­¢ è§£é™¤";
          wakeLock.addEventListener("release", () => {
            document.getElementById("stayAwake").textContent = "ğŸ’¡ ç”»é¢æ¶ˆç¯é˜²æ­¢";
            wakeLock = null;
          });
        } else {
          await wakeLock.release(); wakeLock = null;
        }
      } catch (e) { console.warn(e); alert("ç”»é¢æ¶ˆç¯é˜²æ­¢ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); }
    }

    // ===== ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹é€  =====
    /**
     * schedule = {
     *   id: string,
     *   kind: "once" | "daily" | "weekly" | "dates",
     *   time: "HH:MM" | null,
     *   dt:   epoch_ms | null,
     *   weekdays: number[] | null,  // 0(æ—¥)ã€œ6(åœŸ)
     *   dates: string[] | null,     // "YYYY-MM-DD"[]
     *   videoUrl: string,
     *   startSec: number,
     *   lockMode: boolean,
     *   nextEpoch: number | null,
     *   state: { consumedDates?: Record<string, true> }
     * }
     */

    const statusEl = document.getElementById("status");
    const listEl = document.getElementById("list");
    const ytBox = document.getElementById("ytBox");
    const stayAwakeBtn = document.getElementById("stayAwake");

    let schedules = []; // å…¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
    let locked = false;
    let mustWatch = false;
    let targetUrlPlaying = null;

    // ===== ä¿å­˜ï¼å¾©å…ƒ =====
    function saveAll(){ localStorage.setItem("ytSchedulesV2", JSON.stringify(schedules)); }
    function loadAll(){
      try { schedules = JSON.parse(localStorage.getItem("ytSchedulesV2")||"[]"); }
      catch { schedules = []; }
      if (!Array.isArray(schedules)) schedules = [];
    }

    // ===== æ¬¡å›å®Ÿè¡Œæ™‚åˆ»ã®è¨ˆç®— =====
    function toTodayEpoch(timeHHMM, baseDate = new Date()){
      const [hh, mm] = timeHHMM.split(":").map(Number);
      const d = new Date(baseDate.getFullYear(), baseDate.getMonth(), baseDate.getDate(), hh, mm, 0, 0);
      return d.getTime();
    }

    function calcNextEpoch(s) {
      const now = Date.now();
      const nowD = new Date();

      if (s.kind === "once") {
        return (s.dt && s.dt > now) ? s.dt : null;
      }

      if (s.kind === "daily") {
        let t = toTodayEpoch(s.time, nowD);
        if (t <= now) {
          const d = new Date(t); d.setDate(d.getDate()+1); t = d.getTime();
        }
        return t;
      }

      if (s.kind === "weekly") {
        const set = new Set(s.weekdays||[]);
        if (set.size === 0) return null;
        // ä»Šæ—¥ã‹ã‚‰æœ€å¤§14æ—¥ï¼ˆä»Šé€±+æ¥é€±ï¼‰æ¢ç´¢
        for (let i=0;i<14;i++){
          const d = new Date(now);
          d.setDate(d.getDate()+i);
          const day = d.getDay();
          if (!set.has(day)) continue;
          let t = toTodayEpoch(s.time, d);
          if (i===0 && t<=now) continue; // ãã‚‡ã†é¸æŠï¼†éãã¦ãŸã‚‰æ¬¡ã¸
          return t;
        }
        return null;
      }

      if (s.kind === "dates") {
        const consumed = s.state?.consumedDates || {};
        const dates = (s.dates||[]).filter(d => !consumed[d]).sort();
        for (const iso of dates) {
          const [y,m,d] = iso.split("-").map(Number);
          const t = new Date(y, m-1, d, ...s.time.split(":").map(Number), 0, 0).getTime();
          if (t > now) return t;
        }
        return null; // ã‚‚ã†æ®‹ã£ã¦ãªã„
      }
      return null;
    }

    // ===== äºˆç´„è¿½åŠ  =====
    function addSchedule(obj){
      obj.id = crypto.randomUUID?.() || String(Date.now() + Math.random());
      obj.nextEpoch = calcNextEpoch(obj);
      if (obj.kind === "dates" && !obj.state) obj.state = { consumedDates: {} };
      schedules.push(obj);
      saveAll();
      renderList();
      tickStatus();
    }

    // ===== å®Ÿè¡Œï¼ˆé€šçŸ¥â†’é·ç§»ï¼åŸ‹ã‚è¾¼ã¿ï¼‰ =====
    function fireSchedule(s){
      notify("æ™‚é–“ã«ãªã‚Šã¾ã—ãŸ â°", "æŒ‡å®šã®YouTubeã¸ç§»å‹•ã—ã¾ã™ã€‚");

      // dates ã®å ´åˆã¯ç™ºç«â€œå½“æ—¥â€ã‚’æ¶ˆåŒ–
      if (s.kind === "dates") {
        const fired = new Date();
        const pad = n => String(n).padStart(2,"0");
        const firedISO = `${fired.getFullYear()}-${pad(fired.getMonth()+1)}-${pad(fired.getDate())}`;
        s.state = s.state || { consumedDates: {} };
        s.state.consumedDates[firedISO] = true;
      }

      // æ¬¡å›ã‚’å†è¨ˆç®—
      s.nextEpoch = calcNextEpoch(s);
      saveAll();

      if (s.lockMode) {
        // é–²è¦§å¿…é ˆãƒ¢ãƒ¼ãƒ‰ï¼šã“ã®ãƒšãƒ¼ã‚¸å†…ã§å†ç”Ÿã—ã€å®Œäº†ã§è§£é™¤
        mustWatch = true;
        applyLockUI(true);
        targetUrlPlaying = s.videoUrl;
        loadYouTubePlayer(s.videoUrl);
        document.getElementById("ytBox").scrollIntoView({ behavior: "smooth", block: "center" });
      } else {
        // éãƒ­ãƒƒã‚¯æ™‚ã¯ãƒšãƒ¼ã‚¸é·ç§»
        window.location.href = s.videoUrl;
      }
    }

    // ===== ãƒªã‚¹ãƒˆè¡¨ç¤º =====
    function fmtKind(s){
      if (s.kind==="once") return "1å›";
      if (s.kind==="daily") return "æ¯æ—¥";
      if (s.kind==="weekly") return "æ›œæ—¥æŒ‡å®š";
      if (s.kind==="dates") return "æ—¥ä»˜æŒ‡å®š";
      return s.kind;
    }
    function fmtNext(epoch){
      if (!epoch) return "â€”";
      const d = new Date(epoch);
      const wd = "æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ"[d.getDay()];
      const pad = n => String(n).padStart(2,"0");
      return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())}(${wd}) ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function renderList(){
      listEl.innerHTML = "";
      if (schedules.length===0){
        const p = document.createElement("div");
        p.className = "muted";
        p.textContent = "ï¼ˆç™»éŒ²ãªã—ï¼‰";
        listEl.appendChild(p);
        return;
      }
      for (const s of schedules){
        const div = document.createElement("div");
        div.className = "item";
        const top = document.createElement("div");
        top.className = "top";
        const left = document.createElement("div");
        left.innerHTML = `<div><span class="chip">${fmtKind(s)}</span> <span class="muted">æ¬¡å›: ${fmtNext(s.nextEpoch)}</span></div>
          <div style="word-break:break-all;margin-top:4px" class="muted">${s.videoUrl}</div>`;
        const right = document.createElement("div");
        right.style.display = "flex";
        right.style.gap = "8px";

        const go = document.createElement("button");
        go.className = "btn ghost";
        go.textContent = "ä»Šã™ãé–‹ã";
        go.onclick = ()=> {
          if (s.lockMode) {
            mustWatch = true; applyLockUI(true);
            targetUrlPlaying = s.videoUrl; loadYouTubePlayer(s.videoUrl);
            document.getElementById("ytBox").scrollIntoView({ behavior: "smooth", block: "center" });
          } else {
            window.location.href = s.videoUrl;
          }
        };
        right.appendChild(go);

        const del = document.createElement("button");
        del.className = "btn danger";
        del.textContent = "å‰Šé™¤";
        del.onclick = ()=>{ removeSchedule(s.id); };
        right.appendChild(del);

        top.append(left,right);
        div.appendChild(top);

        // è©³ç´°
        const detail = document.createElement("div");
        if (s.kind==="daily") detail.textContent = `æ™‚åˆ»: ${s.time}`;
        if (s.kind==="weekly") detail.textContent = `æ™‚åˆ»: ${s.time} / æ›œæ—¥: ${s.weekdays.sort().map(n=>"æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ"[n]).join(", ")}`;
        if (s.kind==="dates")  detail.textContent = `æ™‚åˆ»: ${s.time} / æ—¥ä»˜: ${(s.dates||[]).sort().join(", ")}`;
        if (s.kind==="once")   detail.textContent = `æ—¥æ™‚: ${fmtNext(s.dt)}`;
        div.appendChild(detail);

        listEl.appendChild(div);
      }
    }

    function removeSchedule(id){
      schedules = schedules.filter(x=>x.id!==id);
      saveAll(); renderList(); tickStatus();
    }

    // ===== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼†ã‚¿ã‚¤ãƒãƒ¼ =====
    function nearestNext(){
      const actives = schedules.map(s=>s.nextEpoch).filter(Boolean);
      if (actives.length===0) return null;
      return Math.min(...actives);
    }

    function tickStatus(){
      const n = nearestNext();
      if (!n){ statusEl.textContent = "æº–å‚™ä¸­"; return; }
      const remain = Math.max(0, n - Date.now());
      const mins = Math.floor(remain / 60000);
      const secs = Math.floor((remain % 60000) / 1000);
      statusEl.textContent = `æœ€çŸ­ã®ç™ºç«ã¾ã§ï¼šæ®‹ã‚Š ${mins}åˆ† ${secs}ç§’`;
    }

    let tickTimer = null;
    let firingNow = false;

    function startTick(){
      if (tickTimer) clearInterval(tickTimer);
      tickTimer = setInterval(()=>{
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        tickStatus();

        // ç™ºç«ï¼ˆåŒä¸€tickã¯1ä»¶ã ã‘ï¼‰
        const now = Date.now();
        if (firingNow) return;
        const ready = schedules
          .filter(s => s.nextEpoch && now >= s.nextEpoch)
          .sort((a,b)=>a.nextEpoch - b.nextEpoch)[0];

        if (ready){
          firingNow = true;
          try { fireSchedule(ready); }
          finally { firingNow = false; }
        }
      }, 1000);
    }

    // ===== é–²è¦§å¿…é ˆãƒ¢ãƒ¼ãƒ‰ï¼ˆUIãƒ­ãƒƒã‚¯ & YouTube IFrame APIï¼‰ =====
    function applyLockUI(on){
      locked = on;
      // aè¦ç´ ã®ã‚¯ãƒªãƒƒã‚¯ã‚’æŠ‘æ­¢
      document.querySelectorAll("a").forEach(a=>{
        if (on) {
          a.dataset.href = a.getAttribute("href");
          a.removeAttribute("href");
          a.style.pointerEvents = "none"; a.style.opacity = ".4";
          a.title = "å‹•ç”»ã®è¦–è´å®Œäº†ã§è§£é™¤ã•ã‚Œã¾ã™";
        } else {
          if (a.dataset.href) a.setAttribute("href", a.dataset.href);
          a.style.pointerEvents = ""; a.style.opacity = ""; a.title = "";
        }
      });
      ytBox.classList.toggle("hidden", !on);
      // å¿…è¦ãªã‚‰ä»–ã®ãƒŠãƒ“ãƒœã‚¿ãƒ³ã‚‚ã“ã“ã§ç„¡åŠ¹åŒ–ã™ã‚‹
    }

    let ytPlayer = null;
    let ytApiLoading = false;
    function loadYouTubePlayer(url){
      if (!url) return;
      const u = new URL(url);
      const id = u.searchParams.get("v");
      const start = Number(u.searchParams.get("start") || u.searchParams.get("t") || 0);
      if (!id) return;

      const create = () => {
        ytPlayer = new YT.Player("ytBox", {
          videoId: id,
          playerVars: { start, playsinline: 1, rel: 0 },
          events: {
            onReady: ev => { ev.target.playVideo?.(); },
            onStateChange: ev => {
              if (ev.data === YT.PlayerState.ENDED) {
                mustWatch = false;
                applyLockUI(false);
                localStorage.setItem("ytWatched:"+id, "done");
                alert("è¦–è´å®Œäº†ï¼ãƒ­ãƒƒã‚¯è§£é™¤ã—ã¾ã—ãŸã€‚");
              }
            }
          }
        });
      };

      if (window.YT && YT.Player) { create(); return; }
      if (!document.getElementById("ytapi") && !ytApiLoading) {
        ytApiLoading = true;
        const s = document.createElement("script");
        s.id = "ytapi";
        s.src = "https://www.youtube.com/iframe_api";
        document.body.appendChild(s);
      }
      const prev = window.onYouTubeIframeAPIReady;
      window.onYouTubeIframeAPIReady = () => {
        prev?.();
        create();
      };
    }

    // ===== ã‚¤ãƒ™ãƒ³ãƒˆé…ç·š =====
    document.getElementById("enableNotif").addEventListener("click", async ()=>{
      const res = await requestNotificationPermission();
      if (res === "granted") alert("é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¾ã—ãŸã€‚");
      else if (res === "denied") alert("é€šçŸ¥ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸï¼ˆãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã§å¤‰æ›´å¯ï¼‰ã€‚");
    });

    stayAwakeBtn.addEventListener("click", toggleWakeLock);

    // ç¹°ã‚Šè¿”ã— UI åˆ‡æ›¿
    const repeatKind = document.getElementById("repeatKind");
    const onceBox = document.getElementById("onceBox");
    const dailyBox = document.getElementById("dailyBox");
    const weeklyBox = document.getElementById("weeklyBox");
    const datesBox = document.getElementById("datesBox");
    repeatKind.addEventListener("change", ()=>{
      const v = repeatKind.value;
      onceBox.classList.toggle("hidden", v!=="once");
      dailyBox.classList.toggle("hidden", v!=="daily");
      weeklyBox.classList.toggle("hidden", v!=="weekly");
      datesBox.classList.toggle("hidden", v!=="dates");
    });

    // æ—¥ä»˜è¿½åŠ ï¼ˆè¤‡æ•°ï¼‰
    const datesContainer = document.getElementById("datesContainer");
    document.getElementById("addDate").addEventListener("click", ()=>{
      const input = document.createElement("input");
      input.type = "date";
      datesContainer.appendChild(input);
    });

    // äºˆç´„è¿½åŠ 
    document.getElementById("addSchedule").addEventListener("click", ()=>{
      const raw = document.getElementById("videoUrl").value.trim();
      const startSecRaw = Number(document.getElementById("startSec").value);
      const startSec = Math.max(0, Number.isFinite(startSecRaw) ? startSecRaw : 0);
      const lockMode = document.getElementById("lockMode").checked;

      const fixedUrl = normalizeYouTubeUrl(raw, startSec);
      if (!fixedUrl) { alert("YouTube URLã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"); return; }

      const kind = repeatKind.value;

      if (kind === "once"){
        const dtStr = document.getElementById("onceDateTime").value;
        if (!dtStr){ alert("æ—¥æ™‚ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
        const epoch = new Date(dtStr).getTime();
        if (!(epoch > Date.now())){ alert("æœªæ¥ã®æ—¥æ™‚ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
        addSchedule({
          kind:"once", dt: epoch, time: null, weekdays:null, dates:null,
          videoUrl: fixedUrl, startSec, lockMode, state: {}
        });
        alert("1å›ã®äºˆç´„ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚");

      } else if (kind === "daily"){
        const t = document.getElementById("dailyTime").value;
        if (!t){ alert("æ™‚åˆ»ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
        addSchedule({
          kind:"daily", time: t, dt:null, weekdays:null, dates:null,
          videoUrl: fixedUrl, startSec, lockMode, state: {}
        });
        alert("æ¯æ—¥ã®äºˆç´„ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚");

      } else if (kind === "weekly"){
        const t = document.getElementById("weeklyTime").value;
        if (!t){ alert("æ™‚åˆ»ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
        const w = Array.from(document.querySelectorAll(".wday:checked")).map(x=>Number(x.value));
        if (w.length===0){ alert("æ›œæ—¥ã‚’å°‘ãªãã¨ã‚‚1ã¤é¸ã‚“ã§ãã ã•ã„ã€‚"); return; }
        addSchedule({
          kind:"weekly", time: t, dt:null, weekdays:w, dates:null,
          videoUrl: fixedUrl, startSec, lockMode, state: {}
        });
        alert("æ›œæ—¥æŒ‡å®šã®äºˆç´„ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚");

      } else if (kind === "dates"){
        const t = document.getElementById("datesTime").value;
        if (!t){ alert("æ™‚åˆ»ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
        const ds = Array.from(datesContainer.querySelectorAll('input[type="date"]'))
          .map(i=>i.value).filter(Boolean);
        if (ds.length===0){ alert("æ—¥ä»˜ã‚’1ã¤ä»¥ä¸Šè¿½åŠ ã—ã¦ãã ã•ã„ã€‚"); return; }
        // æœªæ¥æ—¥ã ã‘ã«çµã‚‹
        const now = Date.now();
        const [hh,mm] = t.split(":").map(Number);
        const future = ds.filter(s=>{
          const [y,m,d] = s.split("-").map(Number);
          return new Date(y, m-1, d, hh, mm, 0, 0).getTime() > now;
        });
        if (future.length===0){ alert("æœªæ¥ã®æ—¥ä»˜ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚"); return; }
        addSchedule({
          kind:"dates", time: t, dt:null, weekdays:null, dates: future,
          videoUrl: fixedUrl, startSec, lockMode, state: { consumedDates: {} }
        });
        alert("æ—¥ä»˜æŒ‡å®šã®äºˆç´„ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚");
      }
    });

    // ===== åˆæœŸåŒ– =====
    loadAll();
    // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã® nextEpoch ã‚’è£œå®Œ
    for (const s of schedules){ s.nextEpoch = calcNextEpoch(s); }
    saveAll();
    renderList();
    startTick();

    // ===== ãƒšãƒ¼ã‚¸éè¡¨ç¤ºã®æ³¨æ„ =====
    document.addEventListener("visibilitychange", ()=>{
      if (document.hidden) console.log("Background; timers may throttle.");
    });

    // ===== ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ã‚¤ãƒ³ãƒãƒ¼ãƒˆ =====
    document.getElementById("exportJson").addEventListener("click", ()=>{
      const blob = new Blob([JSON.stringify(schedules, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "ytSchedulesV2.json"; a.click();
      URL.revokeObjectURL(url);
    });

    document.getElementById("importJson").addEventListener("click", ()=>{
      document.getElementById("importFile").click();
    });

    document.getElementById("importFile").addEventListener("change", async (e)=>{
      const f = e.target.files?.[0]; if (!f) return;
      const text = await f.text();
      try {
        const arr = JSON.parse(text);
        if (!Array.isArray(arr)) throw new Error("invalid");
        schedules = arr.map(s => ({...s, nextEpoch: calcNextEpoch(s)}));
        saveAll(); renderList(); tickStatus();
        alert("èª­ã¿è¾¼ã¿å®Œäº†");
      } catch { alert("JSONãŒä¸æ­£ã§ã™"); }
    });

    // ===== Service Workerç™»éŒ² =====
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./sw.js").catch(console.warn);
    }
  </script>
</body>
</html>
