<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>YouTube å¿…é ˆè¦–è´ & é€šçŸ¥ãƒ©ãƒ³ãƒãƒ£ãƒ¼</title>
  <meta name="theme-color" content="#111827" />
  <link rel="manifest" href="manifest.webmanifest" />
  <style>
    :root{--bg:#0f172a;--card:#111827;--muted:#9ca3af;--text:#f9fafb;--accent:#22d3ee;}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0f172a 40%);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    .wrap{max-width:680px;margin:0 auto;padding:24px 16px 56px}
    .card{background:rgba(17,24,39,.7);backdrop-filter: blur(10px);border:1px solid rgba(255,255,255,.06);border-radius:20px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.3)}
    h1{font-size:22px;margin:0 0 12px}
    p.lead{color:var(--muted);margin-top:4px}
    label{display:block;font-size:14px;margin:14px 0 6px;color:#e5e7eb}
    input,button,select{font:inherit}
    input[type="url"], input[type="datetime-local"]{
      width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background:#0b1020;color:var(--text);outline:none
    }
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:600px){.row{grid-template-columns:1fr 1fr}}
    .btn{display:inline-flex;gap:8px;align-items:center;border:none;border-radius:12px;padding:12px 16px;font-weight:600;cursor:pointer}
    .primary{background:var(--accent);color:#06202a}
    .ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.14)}
    .danger{background:#ef4444;color:white}
    .muted{color:var(--muted);font-size:13px}
    .badge{display:inline-block;font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.16);color:#93c5fd}
    .lock{display:flex;align-items:center;gap:8px;margin-top:8px}
    .grid{display:grid;gap:12px}
    .yt{aspect-ratio:16/9;background:#0b1020;border:1px dashed rgba(255,255,255,.12);border-radius:12px;display:flex;align-items:center;justify-content:center;color:#94a3b8}
    .footer{margin-top:18px;font-size:12px;color:#a1a1aa}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ğŸ“º YouTube æŒ‡å®šæ™‚åˆ»ã§é€šçŸ¥ï¼†è‡ªå‹•é·ç§»</h1>
      <p class="lead">å‹•ç”»URLã¨é€šçŸ¥ã—ãŸã„æ—¥æ™‚ã‚’ã‚»ãƒƒãƒˆã€‚æ™‚é–“ã«ãªã£ãŸã‚‰é€šçŸ¥ã—ã€æŒ‡å®šå‹•ç”»ã¸ã‚¸ãƒ£ãƒ³ãƒ—ã—ã¾ã™ã€‚</p>

      <div class="grid">
        <div>
          <label>å¯¾è±¡ã®YouTubeå‹•ç”»URL</label>
          <input id="videoUrl" type="url" placeholder="https://www.youtube.com/watch?v=XXXXXXXX" inputmode="url" />
          <div class="muted">ã‚·ãƒ§ãƒ¼ãƒˆURLï¼ˆyoutu.beï¼‰ã‚‚OK</div>
        </div>

        <div class="row">
          <div>
            <label>é€šçŸ¥ã™ã‚‹æ—¥æ™‚ï¼ˆç«¯æœ«ã®ç¾åœ°æ™‚åˆ»ï¼‰</label>
            <input id="when" type="datetime-local" />
          </div>
          <div>
            <label>å‹•ç”»é–‹å§‹ä½ç½®ï¼ˆç§’, ä»»æ„ï¼‰</label>
            <input id="startSec" type="number" min="0" placeholder="ä¾‹ï¼‰120" />
          </div>
        </div>

        <div class="lock">
          <input id="lockMode" type="checkbox" />
          <label for="lockMode">é–²è¦§å¿…é ˆãƒ¢ãƒ¼ãƒ‰ï¼ˆå®Œäº†ã¾ã§ã‚¢ãƒ—ãƒªå†…ãƒªãƒ³ã‚¯ã‚’ãƒ­ãƒƒã‚¯ï¼‰</label>
        </div>

        <div class="row">
          <button id="enableNotif" class="btn ghost" type="button">ğŸ”” é€šçŸ¥ã‚’è¨±å¯</button>
          <button id="start" class="btn primary" type="button">â–¶ äºˆç´„é–‹å§‹</button>
        </div>

        <div class="row">
          <button id="stayAwake" class="btn ghost" type="button">ğŸ’¡ ç”»é¢æ¶ˆç¯é˜²æ­¢</button>
          <button id="cancel" class="btn danger" type="button">âœ– äºˆç´„è§£é™¤</button>
        </div>

        <div id="status" class="badge">æº–å‚™ä¸­</div>

        <div class="yt hidden" id="ytBox">ï¼ˆé–²è¦§å¿…é ˆãƒ¢ãƒ¼ãƒ‰ï¼šå‹•ç”»å®Œäº†ã§è§£é™¤ï¼‰</div>

        <div class="footer">
          <div>â€» ã“ã®ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ã‚‹ï¼ã‚¹ãƒªãƒ¼ãƒ—ä¸­ã¯ã‚¿ã‚¤ãƒãƒ¼ãŒé…å»¶ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚é–‹ã„ãŸã¾ã¾ã®é‹ç”¨ãŒç¢ºå®Ÿã§ã™ã€‚</div>
          <div>â€» iOSã¯â€œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ â€ã™ã‚‹ã¨é€šçŸ¥ã®å®‰å®šåº¦ãŒä¸ŠãŒã‚Šã¾ã™ï¼ˆè¨±å¯ãŒå¿…è¦ï¼‰ã€‚</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---- Utility: URL æ­£è¦åŒ– ï¼† t= ã‚¯ã‚¨ãƒªä»˜ä¸ ---------------------------------
    function normalizeYouTubeUrl(raw, startSec) {
      if (!raw) return null;
      try {
        let url = new URL(raw);
        // youtu.be â†’ www.youtube.com/watch?v=
        if (url.hostname === "youtu.be") {
          const id = url.pathname.replace("/", "");
          url = new URL("https://www.youtube.com/watch?v=" + id);
        }
        // shorts â†’ watch
        if (url.pathname.startsWith("/shorts/")) {
          const id = url.pathname.split("/")[2] || "";
          url = new URL("https://www.youtube.com/watch?v=" + id);
        }
        if (startSec && Number(startSec) > 0) {
          url.searchParams.set("t", String(Number(startSec)));
        }
        return url.toString();
      } catch { return null; }
    }

    // ---- é€šçŸ¥ ---------------------------------------------------------------
    async function requestNotificationPermission() {
      if (!("Notification" in window)) {
        alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯é€šçŸ¥ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
        return "unsupported";
      }
      if (Notification.permission === "granted") return "granted";
      if (Notification.permission === "denied") return "denied";
      const res = await Notification.requestPermission();
      return res;
    }
    function showLocalNotification(title, body) {
      try {
        if (Notification.permission === "granted") {
          new Notification(title, { body });
        }
      } catch (e) {
        console.warn("Notification error:", e);
      }
    }

    // ---- ç”»é¢æ¶ˆç¯é˜²æ­¢ï¼ˆWake Lockï¼‰ ------------------------------------------
    let wakeLock = null;
    async function toggleWakeLock() {
      try {
        if (!("wakeLock" in navigator)) {
          alert("Wake Lockã«æœªå¯¾å¿œã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã™ã€‚");
          return;
        }
        if (!wakeLock) {
          wakeLock = await navigator.wakeLock.request("screen");
          document.getElementById("stayAwake").textContent = "ğŸ’¤ ç”»é¢æ¶ˆç¯é˜²æ­¢ è§£é™¤";
          wakeLock.addEventListener("release", () => {
            document.getElementById("stayAwake").textContent = "ğŸ’¡ ç”»é¢æ¶ˆç¯é˜²æ­¢";
            wakeLock = null;
          });
        } else {
          await wakeLock.release();
          wakeLock = null;
        }
      } catch (e) {
        console.warn(e);
        alert("ç”»é¢æ¶ˆç¯é˜²æ­¢ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ“ä½œç›´å¾Œã«ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã ã•ã„ã€‚");
      }
    }

    // ---- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç† ----------------------------------------------------
    const status = document.getElementById("status");
    const enableNotifBtn = document.getElementById("enableNotif");
    const startBtn = document.getElementById("start");
    const cancelBtn = document.getElementById("cancel");
    const stayAwakeBtn = document.getElementById("stayAwake");
    const ytBox = document.getElementById("ytBox");

    let tickTimer = null;
    let targetEpoch = null;
    let locked = false;
    let targetUrl = null;
    let mustWatch = false;

    function persistState() {
      const state = {
        targetEpoch,
        locked,
        targetUrl,
        mustWatch
      };
      localStorage.setItem("ytLockState", JSON.stringify(state));
    }
    function restoreState() {
      const s = localStorage.getItem("ytLockState");
      if (!s) return;
      try {
        const {targetEpoch:te, locked:l, targetUrl:tu, mustWatch:mw} = JSON.parse(s);
        targetEpoch = te || null;
        locked = !!l;
        targetUrl = tu || null;
        mustWatch = !!mw;
      } catch {}
    }

    function updateStatus() {
      if (targetEpoch) {
        const remain = Math.max(0, targetEpoch - Date.now());
        const mins = Math.floor(remain/60000);
        const secs = Math.floor((remain%60000)/1000);
        status.textContent = `äºˆç´„ä¸­ï¼šæ®‹ã‚Š ${mins}åˆ† ${secs}ç§’`;
      } else {
        status.textContent = "æº–å‚™ä¸­";
      }
    }

    function startTick() {
      stopTick();
      tickTimer = setInterval(() => {
        updateStatus();
        if (targetEpoch && Date.now() >= targetEpoch) {
          stopTick();
          trigger();
        }
      }, 1000);
    }
    function stopTick() {
      if (tickTimer) { clearInterval(tickTimer); tickTimer = null; }
    }

    function trigger() {
      showLocalNotification("æ™‚é–“ã«ãªã‚Šã¾ã—ãŸ â°", "æŒ‡å®šã®YouTubeã¸ç§»å‹•ã—ã¾ã™ã€‚");
      if (!targetUrl) return;
      // å¼·åˆ¶é·ç§»
      window.location.href = targetUrl;
    }

    // ---- é–²è¦§å¿…é ˆãƒ¢ãƒ¼ãƒ‰ï¼šYouTube IFrame APIã§è¦–è´å®Œäº†æ¤œçŸ¥ -------------------
    // ã“ã®ãƒšãƒ¼ã‚¸å†…ã®â€œãƒªãƒ³ã‚¯é¡â€ã‚’ãƒ­ãƒƒã‚¯ã™ã‚‹ï¼ˆç°¡æ˜“çš„ï¼‰
    function applyLockUI(on) {
      locked = on;
      document.querySelectorAll("a").forEach(a=>{
        if (on) {
          a.dataset.href = a.getAttribute("href");
          a.removeAttribute("href");
          a.style.pointerEvents = "none"; a.style.opacity = ".4";
          a.title = "å‹•ç”»ã®è¦–è´å®Œäº†ã§è§£é™¤ã•ã‚Œã¾ã™";
        } else {
          if (a.dataset.href) a.setAttribute("href", a.dataset.href);
          a.style.pointerEvents = ""; a.style.opacity = ""; a.title = "";
        }
      });
      ytBox.classList.toggle("hidden", !on);
      persistState();
    }

    // IFrame API å‹•çš„èª­ã¿è¾¼ã¿
    let ytPlayer = null;
    function loadYouTubePlayer(url) {
      if (!url) return;
      // æŠ½å‡º
      const u = new URL(url);
      const id = u.searchParams.get("v");
      const start = Number(u.searchParams.get("t") || 0);
      if (!id) return;
      // APIã‚¹ã‚¯ãƒªãƒ—ãƒˆ
      if (!document.getElementById("ytapi")) {
        const s = document.createElement("script");
        s.id = "ytapi";
        s.src = "https://www.youtube.com/iframe_api";
        document.body.appendChild(s);
      }
      window.onYouTubeIframeAPIReady = () => {
        ytPlayer = new YT.Player("ytBox", {
          videoId: id,
          playerVars: { start, playsinline: 1, rel: 0 },
          events: {
            onReady: (ev) => { ev.target.playVideo?.(); },
            onStateChange: (ev) => {
              // å†ç”Ÿå®Œäº†ï¼ˆENDED=0â†’çµ‚äº†ã¯ 0? æ­£ã—ãã¯ YT.PlayerState.ENDED=0ï¼Ÿï¼‰
              // å®Ÿå€¤ã¯ YT.PlayerState.ENDED === 0
              if (ev.data === YT.PlayerState.ENDED) {
                mustWatch = false;
                applyLockUI(false);
                localStorage.setItem("ytWatched:"+id, "done");
                alert("è¦–è´å®Œäº†ï¼ãƒ­ãƒƒã‚¯è§£é™¤ã—ã¾ã—ãŸã€‚");
              }
            }
          }
        });
      };
    }

    // ---- ã‚¤ãƒ™ãƒ³ãƒˆ ------------------------------------------------------------
    enableNotifBtn.addEventListener("click", async ()=>{
      const res = await requestNotificationPermission();
      if (res === "granted") alert("é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¾ã—ãŸã€‚");
      else if (res === "denied") alert("é€šçŸ¥ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸï¼ˆãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã§å¤‰æ›´å¯èƒ½ï¼‰ã€‚");
    });

    startBtn.addEventListener("click", ()=>{
      const raw = document.getElementById("videoUrl").value.trim();
      const dt = document.getElementById("when").value;
      const startSec = document.getElementById("startSec").value;
      const lockMode = document.getElementById("lockMode").checked;

      const fixed = normalizeYouTubeUrl(raw, startSec);
      if (!fixed) { alert("YouTube URLã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"); return; }
      if (!dt) { alert("æ—¥æ™‚ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }

      targetUrl = fixed;
      targetEpoch = new Date(dt).getTime();
      if (isNaN(targetEpoch)) { alert("æ—¥æ™‚ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚"); return; }
      if (targetEpoch <= Date.now()) { alert("æœªæ¥ã®æ—¥æ™‚ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }

      if (lockMode) {
        mustWatch = true;
        applyLockUI(true);
        loadYouTubePlayer(targetUrl);
      } else {
        mustWatch = false;
        applyLockUI(false);
      }

      persistState();
      startTick();
      updateStatus();
      alert("äºˆç´„ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸã¾ã¾ã«ã™ã‚‹ã¨ç¢ºå®Ÿã§ã™ã€‚");
    });

    cancelBtn.addEventListener("click", ()=>{
      targetEpoch = null; targetUrl = null; stopTick(); updateStatus();
      mustWatch = false; applyLockUI(false);
      persistState();
      alert("äºˆç´„ã‚’è§£é™¤ã—ã¾ã—ãŸã€‚");
    });

    stayAwakeBtn.addEventListener("click", toggleWakeLock);

    // ãƒšãƒ¼ã‚¸å¾©å…ƒæ™‚ã®å‡¦ç†
    restoreState();
    if (targetEpoch) { startTick(); updateStatus(); }
    if (locked && mustWatch && targetUrl) {
      applyLockUI(true);
      loadYouTubePlayer(targetUrl);
    }

    // ãƒšãƒ¼ã‚¸éè¡¨ç¤ºã®æ³¨æ„ï¼ˆè»½ã„ãƒªãƒã‚¤ãƒ³ãƒ‰ï¼‰
    document.addEventListener("visibilitychange", ()=>{
      if (document.hidden && targetEpoch) {
        console.log("Background; timers may throttle.");
      }
    });

    // SW ç™»éŒ²ï¼ˆPWAãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç”¨é€”ï¼‰
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./sw.js").catch(console.warn);
    }
  </script>
</body>
</html>
